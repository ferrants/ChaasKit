# Code Audit Findings (2026-02-05)

Below is the audit list captured from the current codebase, ordered by severity and aligned to the review sequence: shared, database, server, client, CLI, and docs.

## Critical / High
1. **CORS allows any origin with credentials**. This effectively allows any website to make authenticated requests. Consider restricting to `APP_URL` or an explicit allowlist and handling OAuth/MCP endpoints separately.
   - File: `packages/server/src/app.ts`
   - Status: **Done** (allowlist via `APP_URL`, `API_URL`, `CORS_ALLOWED_ORIGINS`)

2. **Config logging leaks secrets**. `logConfig` claims to redact but logs the full config, which can include API keys, external agent headers, etc.
   - File: `packages/server/src/config/loader.ts`
   - Status: **Done** (redacted logging; no config dump in production)

3. **JWT secret unsafe fallback**. If `JWT_SECRET` isn’t set, the app signs tokens with `'your-secret-key'`. This is a security hole in production and should fail fast.
   - File: `packages/server/src/middleware/auth.ts`
   - Status: **Done** (hard fail in production; dev fallback with warning)

## Medium
4. **Config validation is out of date vs. actual config types and features**. The Zod schema doesn’t cover multi-agent, `sharing.scope`, `documents`, `projects`, `teams`, `admin`, `api`, `queue`, `email`, `scheduledPrompts`, `rateLimit`, or MCP fields like `toolConfirmation`. If validation is used anywhere, it will reject valid configs or miss invalid ones.
   - File: `packages/shared/src/validation/config.ts`
   - Status: **Done** (schema expanded to current config surface)

5. **API key `allowedEndpoints` likely won’t match documented patterns**. `apiKeyAuth` checks `req.path` (path relative to the mounted router). Docs show `/api/...` patterns. In Express, `req.path` for `/api/threads` becomes `/threads`, so `/api/threads` won’t match.
   - File: `packages/server/src/middleware/apiKeyAuth.ts`
   - Docs: `docs/configuration.md` (API Keys)
   - Status: **Done** (match against full path including `/api`)

6. **Magic link email not implemented**. The endpoint logs the link instead of sending it, but docs describe fully functional magic links.
   - File: `packages/server/src/api/auth.ts`
   - Docs: `docs/authentication.md`
   - Status: **Done** (email templates + send via configured provider)

7. **Queue docs say to put handlers in `extensions/jobs`, but extensions loader does not load that directory**. Those handlers won’t run unless the user imports them manually.
   - File: `packages/server/src/extensions/loader.ts`
   - Docs: `docs/queue.md`
   - Status: **Done** (loader now includes `extensions/jobs`)

8. **Default basePath behavior conflicts**. Shared types and docs imply default `/`, but client hooks default to `/chat` if unset, while server defaults don’t set `basePath`. This creates inconsistencies if users omit `basePath`.
   - Files: `packages/shared/src/types/config.ts`, `packages/client/src/hooks/useBasePath.ts`, `packages/client/src/hooks/useAppPath.ts`
   - Docs: `docs/configuration.md`
   - Status: **Done** (default `/chat` aligned in config + docs)

## Low
9. **TODOs representing missing features** (documentation likely implies they exist):
   - Magic link email send TODO (see above)
   - MCP token refresh TODO: `packages/server/src/mcp/client.ts`
   - Tool UI message passing TODO: `packages/client/src/components/ToolCallDisplay.tsx`
   - Payments notification email TODO: `packages/server/src/api/payments.ts`

10. **Shallow config merging** can drop nested defaults when users provide partial objects (e.g., `auth` or `ui`).
   - File: `packages/server/src/config/loader.ts`

## Docs Alignment Issues (Actionable)
1. **CLI invocation mismatch**: docs say `npx chaaskit create`, but the package is `create-chaaskit` with bin `create-chaaskit`.
   - Docs: `docs/installation.md`, `README.md`
   - Code: `packages/create-chaaskit/package.json`, `packages/create-chaaskit/src/index.ts`

2. **API key endpoints patterns** (see Medium #5).
   - Docs: `docs/configuration.md`

3. **Magic link flow** described as functional, but no email send.
   - Docs: `docs/authentication.md`

4. **Queue job handler location** (see Medium #7).
   - Docs: `docs/queue.md`

5. **Base path default mismatch** (see Medium #8).
   - Docs: `docs/configuration.md`

## Test Coverage
- No tests found in `shared`, `db`, `server`, `client`, or `create-chaaskit`.

## Open Questions / Assumptions
- Is the open CORS policy intentional for all endpoints, or only for OAuth/MCP?
- Should `basePath` default to `/chat` (matching templates) or `/` (matching docs/types)?
- Should config validation be enforced at runtime, or is it only for static typing?
